name: Release

on:
  workflow_run:
    workflows: [Build]
    types: [completed]
    branches: [tags]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v0.1.2)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    name: Release
    # Only run after build succeeds on a tag push
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all archives
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          pattern: archive-*
          path: archives
          merge-multiple: true

      - name: Determine version
        run: |
          # Get version from tag
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION=${{ inputs.tag }}
          else
            VERSION=${{ github.event.workflow_run.head_branch }}
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Generate release notes
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # Generate release notes
          if [ -n "${PREV_TAG}" ]; then
            NOTES="## Changes since ${PREV_TAG}\n\n"
            NOTES=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" | sed 's/^/  /')
          else
            NOTES="## Release ${VERSION}\n\n"
            NOTES="Initial release of Claude HUD Enhanced"
          fi

          # Save to file for multiline support
          echo "${NOTES}" > release_notes.txt

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${VERSION}" \
            archives/* \
            --title "${VERSION}" \
            --notes-file release_notes.txt
