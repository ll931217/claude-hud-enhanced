name: Release

on:
  workflow_run:
    workflows: [Build]
    types: [completed]
    branches: [main, tags]
  workflow_dispatch:
    inputs:
      pre_release:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  create-release:
    # Only run after build workflow succeeds on a tag
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'v') &&
      github.event.workflow_run.event == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all archives from build workflow
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          pattern: archive-*
          path: archives
          merge-multiple: true

      - name: Determine version from tag
        run: |
          # Extract tag name from the workflow run
          TAG=${{ github.event.workflow_run.head_branch }}
          echo "VERSION=${TAG}" >> $GITHUB_ENV

      - name: Generate release notes
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # Generate release notes
          if [ -n "${PREV_TAG}" ]; then
            NOTES="## Changes since ${PREV_TAG}\n\n"
            NOTES=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" | sed 's/^/  /')
          else
            NOTES="## Release ${VERSION}\n\n"
            NOTES="Initial release of Claude HUD Enhanced"
          fi

          # Save to file for multiline support
          echo "${NOTES}" > release_notes.txt

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PRE_RELEASE: ${{ github.event_name == 'workflow_dispatch' && inputs.pre_release || 'false' }}
        run: |
          FLAGS=()
          if [ "${PRE_RELEASE}" = "true" ]; then
            FLAGS+=("--prerelease")
          fi

          gh release create "${VERSION}" \
            archives/* \
            --title "${VERSION}" \
            --notes-file release_notes.txt \
            "${FLAGS[@]}"
